# UGOTOFFICE DocSpace Full Stack
# Includes: DocSpace + Custom DocumentServer + MCP Server

version: "3.8"

services:
  # Custom DocumentServer with mobile editing and unlimited connections
  onlyoffice-document-server:
    build:
      context: .
      dockerfile: Dockerfile.documentserver
    image: ugotoffice/documentserver:latest
    container_name: ${DOCUMENT_CONTAINER_NAME:-onlyoffice-documentserver}
    environment:
      - JWT_ENABLED=true
      - JWT_SECRET=${DOCUMENT_SERVER_JWT_SECRET}
      - JWT_HEADER=${DOCUMENT_SERVER_JWT_HEADER}
      - JWT_IN_BODY=true
    volumes:
      - ${VOLUMES_DIR:+${VOLUMES_DIR}/}app_data:/var/www/onlyoffice/Data
      - ${VOLUMES_DIR:+${VOLUMES_DIR}/}log_data:/var/log/onlyoffice
    expose:
      - '80'
    stdin_open: true
    restart: always
    stop_grace_period: 60s
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/info/info.json"]
      interval: 30s
      retries: 5
      start_period: 60s
      timeout: 10s
    networks:
      - onlyoffice

  # DocSpace MCP Server for AI integration
  docspace-mcp-server:
    image: onlyoffice/docspace-mcp:latest
    container_name: ${MCP_CONTAINER_NAME:-docspace-mcp}
    environment:
      - DOCSPACE_BASE_URL=${DOCSPACE_BASE_URL:-http://nginx}
      - DOCSPACE_API_KEY=${DOCSPACE_API_KEY}
      - DOCSPACE_TOOLSETS=${DOCSPACE_TOOLSETS:-files,folders,rooms,people}
      - DOCSPACE_DYNAMIC=${DOCSPACE_DYNAMIC:-true}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    ports:
      - "${MCP_PORT:-3000}:3000"
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      retries: 3
      start_period: 10s
      timeout: 5s
    networks:
      - onlyoffice

networks:
  onlyoffice:
    name: ${NETWORK_NAME:-onlyoffice}
    external: false

volumes:
  log_data:
  app_data:
